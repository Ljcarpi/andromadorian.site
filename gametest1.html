<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Andro Runner</title>
<style>
    :root {
        --bg1: #050826;
        --bg2: #16072e;
        --accent: #38bdf8;
        --accent2: #a855f7;
        --accent3: #facc15;
        --danger: #fb7185;
        --text: #e5e7eb;
        --card-bg: rgba(15, 23, 42, 0.9);
        --lane-border: rgba(148, 163, 184, 0.35);
        --shadow-strong: 0 0 20px rgba(56, 189, 248, 0.8);
    }

    * {
        box-sizing: border-box;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at top, #1d2440 0%, var(--bg1) 35%, #020617 100%);
        color: var(--text);
    }

    .app {
        width: 100%;
        max-width: 480px;
        padding: 16px;
    }

    .card {
        background: radial-gradient(circle at top, rgba(56,189,248,0.1), rgba(15,23,42,0.95));
        border-radius: 18px;
        padding: 20px 16px;
        box-shadow: 0 18px 45px rgba(15,23,42,0.9);
        border: 1px solid rgba(148,163,184,0.35);
        position: relative;
        overflow: hidden;
    }

    .card::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: conic-gradient(from 120deg, rgba(56,189,248,0.18), rgba(168,85,247,0.08), transparent 40%);
        opacity: 0.5;
        filter: blur(2px);
        animation: spin 22s linear infinite;
        pointer-events: none;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .card-inner {
        position: relative;
        z-index: 1;
    }

    h1 {
        margin: 0 0 8px;
        font-size: clamp(1.8rem, 5vw, 2.2rem);
        letter-spacing: 0.16em;
        text-transform: uppercase;
        text-align: center;
        color: #e0f2fe;
        text-shadow: 0 0 16px rgba(56,189,248,0.9);
    }

    .subtitle {
        text-align: center;
        font-size: 0.85rem;
        letter-spacing: 0.24em;
        text-transform: uppercase;
        color: #9ca3af;
        margin-bottom: 16px;
    }

    .btn {
        width: 100%;
        padding: 10px 12px;
        margin-bottom: 10px;
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,0.6);
        background: radial-gradient(circle at top left, rgba(56,189,248,0.16), rgba(15,23,42,0.95));
        color: var(--text);
        font-size: 0.98rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease, background 0.2s ease;
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 18px rgba(56,189,248,0.65);
        border-color: var(--accent);
    }

    .btn.secondary {
        background: radial-gradient(circle at bottom right, rgba(168,85,247,0.18), rgba(15,23,42,0.95));
    }

    .btn.ghost {
        background: transparent;
        border-style: dashed;
        font-size: 0.85rem;
    }

    .hidden {
        display: none !important;
    }

    /* HUD y área de juego */
    #game-screen {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .hud {
        display: flex;
        flex-wrap: wrap;
        gap: 4px 12px;
        align-items: center;
        justify-content: space-between;
        font-size: 0.78rem;
        background: linear-gradient(to right, rgba(15,23,42,0.95), rgba(30,64,175,0.7));
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,0.6);
    }

    .hud span {
        white-space: nowrap;
    }

    .hud-label {
        color: #9ca3af;
    }

    .hud-value {
        font-weight: 600;
        color: #e0f2fe;
    }

    .lives {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .heart {
        color: var(--danger);
        text-shadow: 0 0 8px rgba(248,113,113,0.8);
    }

    #game-area {
        margin-top: 10px;
        position: relative;
        width: 100%;
        max-width: 440px;
        aspect-ratio: 9 / 16;
        margin-inline: auto;
        border-radius: 18px;
        overflow: hidden;
        border: 1px solid rgba(148,163,184,0.5);
        background:
            repeating-linear-gradient(
                to right,
                transparent 0,
                transparent calc(33.333% - 1px),
                var(--lane-border) calc(33.333% - 1px),
                var(--lane-border) 33.333%
            );
        background-color: #020617;
        box-shadow: 0 12px 32px rgba(15,23,42,0.9), 0 0 30px rgba(56,189,248,0.6);
    }

    /* fondo que se desplaza para simular movimiento */
    #game-area::after {
        content: "";
        position: absolute;
        inset: -40%;
        background-image:
            radial-gradient(circle at 50% 0%, rgba(148,163,184,0.3) 0, transparent 55%),
            repeating-linear-gradient(
                to bottom,
                rgba(56,189,248,0.4) 0,
                rgba(56,189,248,0.4) 4px,
                transparent 4px,
                transparent 26px
            );
        opacity: 0.2;
        animation: scroll-bg 0.9s linear infinite;
        pointer-events: none;
    }

    @keyframes scroll-bg {
        from { transform: translateY(0); }
        to   { transform: translateY(40px); }
    }

    .entity {
        position: absolute;
        width: 18%;
        height: 8%;
        transform: translate(-50%, -50%);
        border-radius: 999px;
    }

    #player {
        background: radial-gradient(circle at 20% 0%, #e0f2fe, var(--accent));
        box-shadow:
            0 0 16px rgba(56,189,248,0.9),
            0 0 32px rgba(56,189,248,0.7);
        border: 1px solid rgba(224,242,254,0.6);
    }

    .obstacle {
        background: radial-gradient(circle at 20% 0%, #fecaca, var(--danger));
        box-shadow:
            0 0 16px rgba(248,113,113,0.9),
            0 0 26px rgba(248,113,113,0.7);
        border-radius: 12px;
    }

    .coin {
        width: 14%;
        height: 7%;
        background: radial-gradient(circle at 30% 0%, #fef9c3, var(--accent3));
        box-shadow:
            0 0 14px rgba(250,204,21,0.9),
            0 0 24px rgba(250,204,21,0.7);
        border-radius: 50%;
        border: 1px solid rgba(254,249,195,0.7);
    }

    .pickup-burst {
        pointer-events: none;
        position: absolute;
        width: 20%;
        height: 10%;
        transform: translate(-50%, -50%);
        border-radius: 999px;
        border: 2px solid rgba(250,204,21,0.9);
        opacity: 0.9;
        animation: pickup-burst 0.3s ease-out forwards;
    }

    @keyframes pickup-burst {
        from { transform: translate(-50%, -50%) scale(0.6); opacity: 0.95; }
        to   { transform: translate(-50%, -50%) scale(1.4); opacity: 0; }
    }

    .hit-flash {
        animation: hit-flash 0.25s ease-out;
    }

    @keyframes hit-flash {
        0% { box-shadow: 0 0 0 rgba(248,113,113,0.0); }
        40% { box-shadow: 0 0 40px rgba(248,113,113,0.9); }
        100% { box-shadow: 0 0 0 rgba(248,113,113,0.0); }
    }

    /* Controles móviles */
    .controls-mobile {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
    }

    .control-btn {
        flex: 1;
        max-width: 160px;
        padding: 10px 0;
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,0.7);
        background: radial-gradient(circle at top, rgba(56,189,248,0.18), rgba(15,23,42,0.95));
        color: #e5e7eb;
        font-size: 1.1rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        cursor: pointer;
        touch-action: manipulation;
    }

    /* Modales / paneles */
    .section {
        margin-top: 10px;
    }

    .modal {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 10;
    }

    .modal-content {
        width: 100%;
        max-width: 420px;
        background: var(--card-bg);
        border-radius: 18px;
        border: 1px solid rgba(148,163,184,0.7);
        padding: 16px 14px;
        box-shadow: 0 18px 45px rgba(15,23,42,0.95);
        position: relative;
    }

    .modal-title {
        margin: 0 0 8px;
        font-size: 1.1rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: #e0f2fe;
    }

    .modal-text {
        font-size: 0.9rem;
        color: #e5e7eb;
        line-height: 1.4;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 12px;
        cursor: pointer;
        font-size: 1.1rem;
        color: #9ca3af;
    }

    .options-group {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
    }

    .difficulty-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .pill {
        flex: 1;
        min-width: 80px;
        text-align: center;
        padding: 6px 8px;
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,0.7);
        font-size: 0.8rem;
        cursor: pointer;
        background: radial-gradient(circle at top, rgba(56,189,248,0.12), rgba(15,23,42,0.9));
    }

    .pill.active {
        border-color: var(--accent);
        box-shadow: 0 0 16px rgba(56,189,248,0.9);
        color: #e0f2fe;
    }

    .range-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    input[type="range"] {
        flex: 1;
    }

    /* Tabla de puntuaciones */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 0.78rem;
    }

    th, td {
        padding: 4px 6px;
        text-align: left;
        border-bottom: 1px solid rgba(55,65,81,0.7);
    }

    th {
        font-weight: 600;
        color: #e5e7eb;
    }

    td {
        color: #cbd5f5;
    }

    .text-center {
        text-align: center;
    }

    .game-over-title {
        text-align: center;
        font-size: 1.2rem;
        margin-bottom: 8px;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: #fee2e2;
        text-shadow: 0 0 16px rgba(248,113,113,0.9);
    }

    .game-over-score {
        text-align: center;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }

    @media (max-width: 480px) {
        .hud {
            font-size: 0.72rem;
            padding-inline: 8px;
        }
    }
</style>
</head>
<body>
<div class="app">
    <div class="card">
        <div class="card-inner">

            <!-- MENÚ PRINCIPAL -->
            <div id="menu">
                <h1>Andro Runner</h1>
                <p class="subtitle">Neon lane endless runner</p>

                <button class="btn" id="btn-play">Jugar</button>
                <button class="btn secondary" id="btn-instructions">Instrucciones</button>
                <button class="btn secondary" id="btn-options">Opciones</button>
                <button class="btn ghost" id="btn-scores">Ver tabla de puntuaciones</button>
            </div>

            <!-- PANTALLA DE JUEGO -->
            <div id="game-screen" class="hidden">
                <div class="hud">
                    <span><span class="hud-label">Puntos:</span> <span id="hud-score" class="hud-value">0</span></span>
                    <span><span class="hud-label">Mejor:</span> <span id="hud-best" class="hud-value">0</span></span>
                    <span><span class="hud-label">Dif.:</span> <span id="hud-difficulty" class="hud-value">Normal</span></span>
                    <span class="lives"><span class="hud-label">Vidas:</span> <span id="hud-lives"></span></span>
                </div>
                <div id="game-area">
                    <div id="player" class="entity"></div>
                </div>
                <div class="controls-mobile">
                    <button class="control-btn" id="btn-left">◀</button>
                    <button class="control-btn" id="btn-right">▶</button>
                </div>
                <div class="section">
                    <button class="btn ghost" id="btn-exit">Volver al menú</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL INSTRUCCIONES -->
<div id="modal-instructions" class="modal hidden">
    <div class="modal-content">
        <div class="modal-close" data-close="modal-instructions">✕</div>
        <h2 class="modal-title">Instrucciones</h2>
        <p class="modal-text">
            Corre por tres carriles futuristas evitando obstáculos y recogiendo orbes de energía.
            <br><br>
            <strong>Controles (teclado):</strong><br>
            • Flechas izquierda/derecha o teclas A/D para cambiar de carril.
            <br><br>
            <strong>Móvil:</strong><br>
            • Usa los botones ◀ y ▶ en la parte inferior.
            <br><br>
            Consigue puntos por distancia recorrida y por cada moneda recogida.
        </p>
        <button class="btn" data-close="modal-instructions">Cerrar</button>
    </div>
</div>

<!-- MODAL OPCIONES -->
<div id="modal-options" class="modal hidden">
    <div class="modal-content">
        <div class="modal-close" data-close="modal-options">✕</div>
        <h2 class="modal-title">Opciones</h2>

        <div class="options-group">
            <div><strong>Dificultad</strong></div>
            <div class="difficulty-row">
                <div class="pill" data-difficulty="easy">Fácil</div>
                <div class="pill active" data-difficulty="normal">Normal</div>
                <div class="pill" data-difficulty="hard">Difícil</div>
            </div>
        </div>

        <div class="options-group">
            <div><strong>Volumen</strong> <span style="font-size:0.75rem;color:#9ca3af;">(reservado para futuros sonidos)</span></div>
            <div class="range-row">
                <span style="font-size:0.8rem;">0</span>
                <input type="range" id="volume-range" min="0" max="100" value="60" />
                <span style="font-size:0.8rem;">100</span>
            </div>
        </div>

        <div class="section">
            <button class="btn" data-close="modal-options">Listo</button>
        </div>
    </div>
</div>

<!-- MODAL TABLA DE PUNTUACIONES -->
<div id="modal-scores" class="modal hidden">
    <div class="modal-content">
        <div class="modal-close" data-close="modal-scores">✕</div>
        <h2 class="modal-title">Tabla de puntuaciones</h2>
        <p class="modal-text" style="margin-bottom:6px;font-size:0.85rem;">
            Se guardan las 5 mejores partidas en este dispositivo.
        </p>
        <div id="scores-container"></div>
        <div class="section">
            <button class="btn" data-close="modal-scores">Cerrar</button>
        </div>
    </div>
</div>

<!-- MODAL GAME OVER -->
<div id="modal-gameover" class="modal hidden">
    <div class="modal-content">
        <h2 class="game-over-title">Game Over</h2>
        <p class="game-over-score">
            Puntuación: <strong><span id="go-score">0</span></strong><br>
            Mejor puntuación: <strong><span id="go-best">0</span></strong>
        </p>
        <div class="section">
            <button class="btn" id="btn-retry">Jugar de nuevo</button>
            <button class="btn secondary" id="btn-back-menu">Volver al menú</button>
        </div>
    </div>
</div>

<script>
(() => {
    // ==========================
    //  ESTADO GENERAL
    // ==========================
    const menuEl = document.getElementById("menu");
    const gameScreenEl = document.getElementById("game-screen");
    const gameAreaEl = document.getElementById("game-area");
    const playerEl = document.getElementById("player");

    const hudScoreEl = document.getElementById("hud-score");
    const hudBestEl = document.getElementById("hud-best");
    const hudDiffEl = document.getElementById("hud-difficulty");
    const hudLivesEl = document.getElementById("hud-lives");

    const modalInstructions = document.getElementById("modal-instructions");
    const modalOptions = document.getElementById("modal-options");
    const modalScores = document.getElementById("modal-scores");
    const modalGameOver = document.getElementById("modal-gameover");
    const scoresContainer = document.getElementById("scores-container");

    const goScoreEl = document.getElementById("go-score");
    const goBestEl = document.getElementById("go-best");

    const btnPlay = document.getElementById("btn-play");
    const btnInstructions = document.getElementById("btn-instructions");
    const btnOptions = document.getElementById("btn-options");
    const btnScores = document.getElementById("btn-scores");
    const btnExit = document.getElementById("btn-exit");
    const btnRetry = document.getElementById("btn-retry");
    const btnBackMenu = document.getElementById("btn-back-menu");
    const btnLeft = document.getElementById("btn-left");
    const btnRight = document.getElementById("btn-right");

    const difficultyPills = document.querySelectorAll(".pill[data-difficulty]");
    const volumeRange = document.getElementById("volume-range");

    const LS_BEST = "AndroRunnerBestScore";
    const LS_TABLE = "AndroRunnerScoreTable";

    const difficulties = {
        easy: {
            label: "Fácil",
            baseSpeed: 270,
            obstacleInterval: 950,
            coinInterval: 650,
            lives: 3
        },
        normal: {
            label: "Normal",
            baseSpeed: 360,
            obstacleInterval: 780,
            coinInterval: 750,
            lives: 2
        },
        hard: {
            label: "Difícil",
            baseSpeed: 460,
            obstacleInterval: 620,
            coinInterval: 900,
            lives: 1
        }
    };

    let currentDifficultyKey = "normal";
    let currentDifficulty = difficulties[currentDifficultyKey];

    // Estado de partida
    let isPlaying = false;
    let playerLane = 1; // 0,1,2
    let distance = 0;
    let score = 0;
    let bestScore = loadBestScore();
    let lives = currentDifficulty.lives;
    let coinsCollected = 0;

    let obstacles = [];
    let coins = [];

    let lastTime = null;
    let speed = currentDifficulty.baseSpeed;
    let obstacleTimer = 0;
    let coinTimer = 0;

    // ==========================
    //  UTILIDAD STORAGE
    // ==========================
    function loadBestScore() {
        const v = parseInt(localStorage.getItem(LS_BEST), 10);
        return isNaN(v) ? 0 : v;
    }

    function saveBestScore(value) {
        if (value > bestScore) {
            bestScore = value;
            localStorage.setItem(LS_BEST, String(value));
        }
    }

    function loadScoreTable() {
        const raw = localStorage.getItem(LS_TABLE);
        if (!raw) return [];
        try {
            const arr = JSON.parse(raw);
            return Array.isArray(arr) ? arr : [];
        } catch {
            return [];
        }
    }

    function saveScoreToTable(pts, difficultyKey) {
        if (pts <= 0) return;

        const table = loadScoreTable();
        const now = new Date();
        const dateStr = now.toLocaleDateString("es-AR", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric"
        });
        const timeStr = now.toLocaleTimeString("es-AR", {
            hour: "2-digit",
            minute: "2-digit"
        });

        table.push({
            score: pts,
            datetime: dateStr + " " + timeStr,
            difficulty: difficulties[difficultyKey]?.label || difficultyKey
        });

        table.sort((a, b) => b.score - a.score);
        const trimmed = table.slice(0, 5);
        localStorage.setItem(LS_TABLE, JSON.stringify(trimmed));
    }

    function renderScoreTable() {
        const table = loadScoreTable();
        if (!table.length) {
            scoresContainer.innerHTML = "<p class='modal-text'>Todavía no hay puntuaciones guardadas.</p>";
            return;
        }

        let html = "<table><thead><tr>" +
                   "<th>#</th><th>Puntos</th><th>Dificultad</th><th>Fecha</th></tr></thead><tbody>";

        table.forEach((entry, idx) => {
            html += `<tr>
                <td>${idx + 1}</td>
                <td>${entry.score}</td>
                <td>${entry.difficulty}</td>
                <td>${entry.datetime}</td>
            </tr>`;
        });

        html += "</tbody></table>";
        scoresContainer.innerHTML = html;
    }

    // ==========================
    //  MENÚS Y MODALES
    // ==========================
    function showMenu() {
        isPlaying = false;
        menuEl.classList.remove("hidden");
        gameScreenEl.classList.add("hidden");
        hideModal(modalGameOver);
    }

    function startGameFromMenu() {
        menuEl.classList.add("hidden");
        gameScreenEl.classList.remove("hidden");
        startNewRun();
    }

    function showModal(modal) {
        modal.classList.remove("hidden");
    }

    function hideModal(modal) {
        modal.classList.add("hidden");
    }

    document.querySelectorAll("[data-close]").forEach(btn => {
        btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-close");
            const el = document.getElementById(id);
            if (el) hideModal(el);
        });
    });

    document.querySelectorAll(".modal-close").forEach(close => {
        close.addEventListener("click", () => {
            const id = close.getAttribute("data-close");
            if (id) {
                hideModal(document.getElementById(id));
            } else {
                close.closest(".modal").classList.add("hidden");
            }
        });
    });

    // ==========================
    //  DIFICULTAD
    // ==========================
    function setDifficulty(key) {
        if (!difficulties[key]) return;
        currentDifficultyKey = key;
        currentDifficulty = difficulties[key];
        difficultyPills.forEach(p => p.classList.toggle("active", p.dataset.difficulty === key));
        hudDiffEl.textContent = currentDifficulty.label;
    }

    difficultyPills.forEach(pill => {
        pill.addEventListener("click", () => {
            setDifficulty(pill.dataset.difficulty);
        });
    });

    // ==========================
    //  JUEGO
    // ==========================
    function resetState() {
        playerLane = 1;
        distance = 0;
        score = 0;
        coinsCollected = 0;
        speed = currentDifficulty.baseSpeed;
        obstacles.forEach(o => o.el.remove());
        coins.forEach(c => c.el.remove());
        obstacles = [];
        coins = [];
        lives = currentDifficulty.lives;
        obstacleTimer = 0;
        coinTimer = 0;
        lastTime = null;
        updateHUD();
        positionPlayer();
    }

    function startNewRun() {
        resetState();
        isPlaying = true;
        requestAnimationFrame(gameLoop);
    }

    function gameLoop(timestamp) {
        if (!isPlaying) return;
        if (!lastTime) lastTime = timestamp;
        const delta = (timestamp - lastTime) / 1000;
        lastTime = timestamp;

        updateGame(delta);

        if (isPlaying) {
            requestAnimationFrame(gameLoop);
        }
    }

    function updateGame(delta) {
        // Distancia y velocidad progresiva
        distance += speed * delta;
        speed = currentDifficulty.baseSpeed + distance * 0.02;

        // Generación de obstáculos y monedas
        obstacleTimer += delta * 1000;
        coinTimer += delta * 1000;

        if (obstacleTimer >= currentDifficulty.obstacleInterval) {
            obstacleTimer = 0;
            spawnObstacle();
        }

        if (coinTimer >= currentDifficulty.coinInterval) {
            coinTimer = 0;
            spawnCoin();
        }

        // Mover entidades
        const areaHeight = gameAreaEl.clientHeight || 1;
        const moveAmount = speed * delta;

        obstacles.forEach(o => {
            o.y += moveAmount;
            updateEntityPosition(o);
        });

        coins.forEach(c => {
            c.y += moveAmount * 0.9;
            updateEntityPosition(c);
        });

        // Colisiones y limpieza
        const playerY = areaHeight * 0.82;
        const collisionThreshold = areaHeight * 0.08;

        obstacles = obstacles.filter(o => {
            if (Math.abs(o.y - playerY) < collisionThreshold && o.lane === playerLane) {
                registerHit();
                o.el.remove();
                return false;
            }

            if (o.y > areaHeight + 40) {
                o.el.remove();
                return false;
            }
            return true;
        });

        coins = coins.filter(c => {
            if (Math.abs(c.y - playerY) < collisionThreshold && c.lane === playerLane) {
                registerCoinPickup(c);
                c.el.remove();
                return false;
            }

            if (c.y > areaHeight + 40) {
                c.el.remove();
                return false;
            }
            return true;
        });

        // Puntuación
        const distanceScore = Math.floor(distance / 10);
        score = distanceScore + coinsCollected * 100;
        updateHUD();
    }

    function updateHUD() {
        hudScoreEl.textContent = score;
        hudBestEl.textContent = bestScore;
        hudDiffEl.textContent = currentDifficulty.label;
        hudLivesEl.innerHTML = "";
        for (let i = 0; i < lives; i++) {
            const span = document.createElement("span");
            span.className = "heart";
            span.textContent = "❤";
            hudLivesEl.appendChild(span);
        }
    }

    function laneToXPercent(lane) {
        // 3 carriles: centrados aproximadamente
        return (lane * 33.3333) + 16.6666; // 16.6%, 50%, 83.3%
    }

    function positionPlayer() {
        const x = laneToXPercent(playerLane);
        const areaHeight = gameAreaEl.clientHeight || 1;
        const y = areaHeight * 0.82;
        playerEl.style.left = x + "%";
        playerEl.style.top = y + "px";
    }

    function spawnObstacle() {
        const lane = Math.floor(Math.random() * 3);
        const el = document.createElement("div");
        el.className = "entity obstacle";
        gameAreaEl.appendChild(el);

        const obj = {
            type: "obstacle",
            lane,
            y: -40,
            el
        };
        obstacles.push(obj);
        updateEntityPosition(obj);
    }

    function spawnCoin() {
        const lane = Math.floor(Math.random() * 3);
        const el = document.createElement("div");
        el.className = "entity coin";
        gameAreaEl.appendChild(el);

        const obj = {
            type: "coin",
            lane,
            y: -30,
            el
        };
        coins.push(obj);
        updateEntityPosition(obj);
    }

    function updateEntityPosition(obj) {
        const x = laneToXPercent(obj.lane);
        obj.el.style.left = x + "%";
        obj.el.style.top = obj.y + "px";
    }

    function registerCoinPickup(coin) {
        coinsCollected++;
        // efecto visual
        const burst = document.createElement("div");
        burst.className = "pickup-burst";
        burst.style.left = coin.el.style.left;
        burst.style.top = coin.el.style.top;
        gameAreaEl.appendChild(burst);
        setTimeout(() => burst.remove(), 280);
    }

    function registerHit() {
        if (lives <= 0) return;
        lives--;
        gameAreaEl.classList.remove("hit-flash");
        void gameAreaEl.offsetWidth;
        gameAreaEl.classList.add("hit-flash");
        updateHUD();
        if (lives <= 0) {
            endRun();
        }
    }

    function endRun() {
        isPlaying = false;
        saveBestScore(score);
        saveScoreToTable(score, currentDifficultyKey);
        goScoreEl.textContent = score;
        goBestEl.textContent = bestScore;
        showModal(modalGameOver);
    }

    // ==========================
    //  INPUT
    // ==========================
    function moveLeft() {
        if (!isPlaying) return;
        if (playerLane > 0) {
            playerLane--;
            positionPlayer();
        }
    }

    function moveRight() {
        if (!isPlaying) return;
        if (playerLane < 2) {
            playerLane++;
            positionPlayer();
        }
    }

    window.addEventListener("keydown", (e) => {
        const key = e.key.toLowerCase();
        if (key === "arrowleft" || key === "a") {
            e.preventDefault();
            moveLeft();
        } else if (key === "arrowright" || key === "d") {
            e.preventDefault();
            moveRight();
        }
    });

    btnLeft.addEventListener("click", moveLeft);
    btnRight.addEventListener("click", moveRight);

    // ==========================
    //  BOTONES PRINCIPALES
    // ==========================
    btnPlay.addEventListener("click", () => {
        hideModal(modalGameOver);
        startGameFromMenu();
    });

    btnInstructions.addEventListener("click", () => {
        showModal(modalInstructions);
    });

    btnOptions.addEventListener("click", () => {
        showModal(modalOptions);
    });

    btnScores.addEventListener("click", () => {
        renderScoreTable();
        showModal(modalScores);
    });

    btnExit.addEventListener("click", () => {
        showMenu();
    });

    btnRetry.addEventListener("click", () => {
        hideModal(modalGameOver);
        menuEl.classList.add("hidden");
        gameScreenEl.classList.remove("hidden");
        startNewRun();
    });

    btnBackMenu.addEventListener("click", () => {
        hideModal(modalGameOver);
        showMenu();
    });

    // Inicialización
    setDifficulty("normal");
    hudBestEl.textContent = bestScore;
    positionPlayer();
})();
</script>
</body>
</html>
