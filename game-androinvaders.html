<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Andro Invaders</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        /* ===== RESET BÁSICO ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #1b2565 0%, #050816 50%, #02040d 100%);
            color: #f5f5ff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== CONTENEDOR GENERAL ===== */
        #game-wrapper {
            width: 100%;
            max-width: 900px;
            padding: 12px;
        }

        #game-container {
            position: relative;
            background: radial-gradient(circle at top, rgba(50, 80, 200, 0.3), rgba(0, 0, 0, 0.9));
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 255, 0.3);
            box-shadow: 0 0 40px rgba(79, 70, 229, 0.5);
            overflow: hidden;
        }

        /* ===== HUD SUPERIOR ===== */
        #hud {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            padding: 8px 12px;
            font-size: 12px;
            background: linear-gradient(to right, rgba(10, 18, 40, 0.9), rgba(15, 6, 40, 0.9));
            border-bottom: 1px solid rgba(148, 163, 255, 0.3);
        }

        #hud span {
            white-space: nowrap;
        }

        #hud strong {
            color: #facc15;
        }

        /* ===== CANVAS ===== */
        #gameCanvas {
            display: block;
            width: 100%;
            height: auto;
            background: transparent;
        }

        /* ===== CONTROLES MÓVILES ===== */
        #mobile-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 8px 0 12px 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0.0));
        }

        .control-button {
            flex: 1;
            max-width: 120px;
            padding: 10px;
            text-align: center;
            border-radius: 99px;
            border: 1px solid rgba(96, 165, 250, 0.7);
            background: radial-gradient(circle at top, rgba(59, 130, 246, 0.4), rgba(15, 23, 42, 0.9));
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            cursor: pointer;
            user-select: none;
        }

        .control-button:active {
            transform: translateY(1px) scale(0.97);
            box-shadow: 0 0 16px rgba(59, 130, 246, 0.9);
        }

        /* En pantallas grandes, controles móviles más pequeños */
        @media (min-width: 768px) {
            #mobile-controls {
                padding-top: 4px;
            }
            .control-button {
                max-width: 150px;
                font-size: 11px;
            }
        }

        /* ===== OVERLAYS / MENÚS ===== */
        .overlay {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(3,7,18,0.98));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            z-index: 5;
        }

        .hidden {
            display: none !important;
        }

        .overlay-title {
            font-size: 26px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #e5e7eb;
            text-shadow: 0 0 18px rgba(129,140,248,0.9);
        }

        .overlay-subtitle {
            font-size: 13px;
            margin-bottom: 16px;
            color: #9ca3af;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            max-width: 260px;
            margin: 10px auto 0;
        }

        .btn {
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid rgba(129, 140, 248, 0.7);
            background: radial-gradient(circle at top, rgba(129, 140, 248, 0.7), rgba(17, 24, 39, 0.98));
            color: #e5e7eb;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.7);
        }

        .btn.secondary {
            background: radial-gradient(circle at top, rgba(55, 65, 81, 0.9), rgba(15, 23, 42, 0.98));
            border-color: rgba(148, 163, 184, 0.9);
            box-shadow: none;
        }

        .btn.small {
            font-size: 11px;
            padding: 7px 10px;
            letter-spacing: 0.08em;
        }

        .btn:active {
            transform: translateY(1px) scale(0.97);
            box-shadow: 0 0 24px rgba(129, 140, 248, 0.9);
        }

        .difficulty-option {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 255, 0.4);
            margin-bottom: 8px;
            cursor: pointer;
            background: linear-gradient(to right, rgba(17,24,39,0.95), rgba(15,23,42,0.95));
            font-size: 13px;
        }

        .difficulty-option.selected {
            border-color: #facc15;
            box-shadow: 0 0 24px rgba(250, 204, 21, 0.5);
        }

        .difficulty-option strong {
            color: #e5e7eb;
        }

        .difficulty-option span {
            display: block;
            font-size: 11px;
            color: #9ca3af;
            margin-top: 3px;
        }

        .overlay-content {
            max-width: 420px;
            text-align: left;
            font-size: 13px;
            color: #d1d5db;
        }

        .overlay-content h3 {
            font-size: 14px;
            margin-top: 8px;
            margin-bottom: 4px;
            color: #e5e7eb;
        }

        .overlay-content ul {
            margin-left: 18px;
            margin-bottom: 6px;
        }

        .overlay-content li {
            margin-bottom: 3px;
        }

        .score-highlight {
            font-size: 15px;
            margin: 6px 0;
            color: #facc15;
        }

        .tag {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.7);
            font-size: 11px;
            margin-top: 4px;
        }

        .small-note {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
<div id="game-wrapper">
    <div id="game-container">
        <!-- HUD -->
        <div id="hud">
            <span>Puntos: <strong id="hud-score">0</strong></span>
            <span>Mejor: <strong id="hud-highscore">0</strong></span>
            <span>Vidas: <strong id="hud-lives">0</strong></span>
            <span>Oleada: <strong id="hud-wave">1</strong></span>
            <span>Dificultad: <strong id="hud-diff">Normal</strong></span>
        </div>

        <!-- Canvas de juego (resolución lógica fija, escala responsive vía CSS) -->
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <!-- Controles móviles -->
        <div id="mobile-controls">
            <button class="control-button" id="btn-left">&#9664; Izquierda</button>
            <button class="control-button" id="btn-fire">&#11014; Disparar</button>
            <button class="control-button" id="btn-right">Derecha &#9654;</button>
        </div>

        <!-- Menú principal -->
        <div class="overlay" id="mainMenu">
            <div>
                <div class="overlay-title">Andro Invaders</div>
                <div class="overlay-subtitle">Defiende la órbita Andro de la invasión alienígena.</div>
                <div class="menu-buttons">
                    <button class="btn" id="btn-play-main">Jugar</button>
                    <button class="btn secondary" id="btn-difficulty-menu">Dificultad</button>
                    <button class="btn secondary" id="btn-instructions-menu">Instrucciones</button>
                    <button class="btn secondary" id="btn-highscores-menu">High Scores</button>
                </div>
                <div class="small-note">
                    PC: Flechas / A-D para moverse, Espacio para disparar<br />
                    Móvil: Usa los botones en pantalla.
                </div>
            </div>
        </div>

        <!-- Menú de dificultad -->
        <div class="overlay hidden" id="difficultyMenu">
            <div>
                <div class="overlay-title">Dificultad</div>
                <div class="overlay-subtitle">Ajusta el número de enemigos, la velocidad y tus vidas.</div>
                <div id="difficultyOptions">
                    <div class="difficulty-option" data-difficulty="easy">
                        <strong>Fácil</strong>
                        <span>Menos enemigos, disparos enemigos lentos, más vidas.</span>
                    </div>
                    <div class="difficulty-option selected" data-difficulty="normal">
                        <strong>Normal</strong>
                        <span>Equilibrado: desafío estándar.</span>
                    </div>
                    <div class="difficulty-option" data-difficulty="extreme">
                        <strong>Extremo</strong>
                        <span>Muchos enemigos, disparos rápidos y pocas vidas.</span>
                    </div>
                </div>
                <div class="menu-buttons">
                    <button class="btn small" id="btn-diff-accept">Aceptar</button>
                    <button class="btn small secondary" id="btn-diff-back">Volver</button>
                </div>
            </div>
        </div>

        <!-- Pantalla de instrucciones -->
        <div class="overlay hidden" id="instructionsScreen">
            <div>
                <div class="overlay-title">Instrucciones</div>
                <div class="overlay-content">
                    <h3>Controles en teclado</h3>
                    <ul>
                        <li><strong>Movimiento:</strong> Flechas izquierda/derecha o teclas A/D.</li>
                        <li><strong>Disparo:</strong> Barra espaciadora.</li>
                    </ul>

                    <h3>Controles en móvil</h3>
                    <ul>
                        <li>Botón <strong>Izquierda</strong> / <strong>Derecha</strong> para mover la nave.</li>
                        <li>Botón <strong>Disparar</strong> para lanzar proyectiles.</li>
                    </ul>

                    <h3>Cómo se gana y se pierde</h3>
                    <ul>
                        <li>Destruye a los invasores para subir tu <strong>puntaje</strong>.</li>
                        <li>Completa oleadas: cada oleada superada aumenta la dificultad.</li>
                        <li>Si un disparo enemigo te alcanza, pierdes una <strong>vida</strong>.</li>
                        <li>Si un enemigo llega a la parte inferior de la pantalla: <strong>Game Over</strong>.</li>
                    </ul>

                    <h3>Sistema de puntuación</h3>
                    <ul>
                        <li>Enemigo estándar: <strong>100</strong> puntos.</li>
                        <li>Enemigo resistente: <strong>200</strong> puntos.</li>
                        <li>Jefe (cuando aparezca): <strong>500</strong> puntos.</li>
                        <li>Tu mejor puntuación se guarda en este navegador usando <strong>localStorage</strong>.</li>
                    </ul>

                    <h3>Power-ups</h3>
                    <ul>
                        <li><strong>Disparo doble:</strong> Lanzás dos proyectiles a la vez durante unos segundos.</li>
                        <li><strong>Escudo:</strong> Bloquea temporalmente un impacto enemigo.</li>
                        <li><strong>Ralentizar:</strong> Reduce la velocidad de los enemigos por un tiempo.</li>
                    </ul>
                </div>
                <div class="menu-buttons">
                    <button class="btn small" id="btn-instructions-back">Volver al menú</button>
                </div>
            </div>
        </div>

        <!-- Pantalla de High Scores -->
        <div class="overlay hidden" id="highScoresScreen">
            <div>
                <div class="overlay-title">High Scores</div>
                <div class="overlay-content" id="highScoresContent">
                    <!-- Se rellena desde JS -->
                </div>
                <div class="menu-buttons">
                    <button class="btn small" id="btn-highscores-back">Volver al menú</button>
                </div>
            </div>
        </div>

        <!-- Pantalla de Game Over / Victoria -->
        <div class="overlay hidden" id="gameOverScreen">
            <div>
                <div class="overlay-title" id="gameOverTitle">Game Over</div>
                <div class="overlay-content" style="text-align:center;">
                    <div class="score-highlight">
                        Puntuación final: <span id="finalScore">0</span>
                    </div>
                    <div class="score-highlight">
                        Oleada máxima: <span id="finalWave">1</span>
                    </div>
                    <div class="score-highlight">
                        Mejor puntuación global: <span id="bestScoreGlobal">0</span>
                    </div>
                    <div class="tag" id="tagDifficulty">Dificultad: Normal</div>
                    <div class="small-note" id="gameOverNote" style="margin-top:10px;">
                        Sigue defendiendo la órbita Andro. ¡Inténtalo de nuevo!
                    </div>
                </div>
                <div class="menu-buttons">
                    <button class="btn" id="btn-play-again">Jugar de nuevo</button>
                    <button class="btn secondary" id="btn-back-to-menu">Volver al menú</button>
                </div>
            </div>
        </div>
    </div>

    <div class="small-note" style="margin-top:6px; text-align:center;">
        © 2024 Andromadorian – Andro Invaders (HTML5 arcade, sólo cliente).
    </div>
</div>

<script>
    // =========================
    // CONFIGURACIÓN GENERAL
    // =========================

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const HUD_SCORE = document.getElementById('hud-score');
    const HUD_HIGHSCORE = document.getElementById('hud-highscore');
    const HUD_LIVES = document.getElementById('hud-lives');
    const HUD_WAVE = document.getElementById('hud-wave');
    const HUD_DIFF = document.getElementById('hud-diff');

    const mainMenu = document.getElementById('mainMenu');
    const difficultyMenu = document.getElementById('difficultyMenu');
    const instructionsScreen = document.getElementById('instructionsScreen');
    const highScoresScreen = document.getElementById('highScoresScreen');
    const highScoresContent = document.getElementById('highScoresContent');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const gameOverTitle = document.getElementById('gameOverTitle');
    const finalScoreEl = document.getElementById('finalScore');
    const finalWaveEl = document.getElementById('finalWave');
    const bestScoreGlobalEl = document.getElementById('bestScoreGlobal');
    const tagDifficulty = document.getElementById('tagDifficulty');
    const gameOverNote = document.getElementById('gameOverNote');

    const btnPlayMain = document.getElementById('btn-play-main');
    const btnDifficultyMenu = document.getElementById('btn-difficulty-menu');
    const btnInstructionsMenu = document.getElementById('btn-instructions-menu');
    const btnHighScoresMenu = document.getElementById('btn-highscores-menu');

    const btnDiffAccept = document.getElementById('btn-diff-accept');
    const btnDiffBack = document.getElementById('btn-diff-back');

    const btnInstructionsBack = document.getElementById('btn-instructions-back');
    const btnHighScoresBack = document.getElementById('btn-highscores-back');

    const btnPlayAgain = document.getElementById('btn-play-again');
    const btnBackToMenu = document.getElementById('btn-back-to-menu');

    const btnLeft = document.getElementById('btn-left');
    const btnRight = document.getElementById('btn-right');
    const btnFire = document.getElementById('btn-fire');

    // Resolución lógica del juego (el canvas se escala via CSS)
    const GAME_WIDTH = 800;
    const GAME_HEIGHT = 600;

    // Dificultades
    const DIFFICULTIES = {
        easy: {
            key: 'easy',
            label: 'Fácil',
            playerLives: 5,
            enemySpeed: 40,
            enemyDrop: 25,
            enemyShootChance: 0.0010, // por fotograma aprox
            enemyBulletSpeed: 170,
            enemyRows: 4,
            enemyCols: 8,
            powerUpChance: 0.18
        },
        normal: {
            key: 'normal',
            label: 'Normal',
            playerLives: 4,
            enemySpeed: 60,
            enemyDrop: 28,
            enemyShootChance: 0.0016,
            enemyBulletSpeed: 200,
            enemyRows: 5,
            enemyCols: 9,
            powerUpChance: 0.14
        },
        extreme: {
            key: 'extreme',
            label: 'Extremo',
            playerLives: 3,
            enemySpeed: 85,
            enemyDrop: 32,
            enemyShootChance: 0.0024,
            enemyBulletSpeed: 230,
            enemyRows: 6,
            enemyCols: 10,
            powerUpChance: 0.10
        }
    };

    let currentDifficultyKey = 'normal';
    let currentDifficulty = DIFFICULTIES[currentDifficultyKey];

    // Estado del juego
    let gameState = 'menu'; // 'menu', 'playing', 'gameover'
    let score = 0;
    let highScore = 0;
    let wave = 1;
    let bestWave = 1;

    // Entidades
    let player;
    let playerBullets = [];
    let enemyBullets = [];
    let enemies = [];
    let powerUps = [];
    let explosions = [];
    let stars = [];

    let enemyDirection = 1; // 1 = derecha, -1 = izquierda
    let baseEnemySpeed = currentDifficulty.enemySpeed;

    // Control de tiempo / animación
    let lastTime = 0;
    let gameLoopId = null;

    // Control de entrada
    const keys = {};
    let mobileMoveLeft = false;
    let mobileMoveRight = false;
    let mobileFiring = false;

    // Power-ups temporales
    let slowEnemiesTimer = 0;       // ms
    const SLOW_FACTOR = 0.45;
    let VICTORY_WAVE = 10;          // oleada para considerar "Victoria"

    // =========================
    // UTILIDADES
    // =========================

    function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
    }

    function rectsCollide(a, b) {
        return !(
            a.x + a.width < b.x ||
            a.x > b.x + b.width ||
            a.y + a.height < b.y ||
            a.y > b.y + b.height
        );
    }

    function getRandomItem(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    // =========================
    // LOCALSTORAGE (High Scores)
    // =========================

    function loadHighScores() {
        try {
            const savedScore = localStorage.getItem('androInvadersHighScore');
            const savedWave = localStorage.getItem('androInvadersBestWave');

            highScore = savedScore ? parseInt(savedScore, 10) : 0;
            bestWave = savedWave ? parseInt(savedWave, 10) : 1;
        } catch (e) {
            highScore = 0;
            bestWave = 1;
        }
    }

    function saveHighScores() {
        try {
            if (score > highScore) {
                localStorage.setItem('androInvadersHighScore', String(score));
                highScore = score;
            }
            if (wave > bestWave) {
                localStorage.setItem('androInvadersBestWave', String(wave));
                bestWave = wave;
            }
        } catch (e) {
            // Ignorar si localStorage no está disponible
        }
    }

    function refreshHud() {
        HUD_SCORE.textContent = score;
        HUD_HIGHSCORE.textContent = highScore;
        HUD_LIVES.textContent = player ? player.lives : 0;
        HUD_WAVE.textContent = wave;
        HUD_DIFF.textContent = currentDifficulty.label;
    }

    function fillHighScoresScreen() {
        highScoresContent.innerHTML = `
            <p>
                <strong>Mejor puntuación guardada:</strong>
                <span style="color:#facc15;">${highScore}</span><br/>
                <strong>Mejor oleada alcanzada:</strong>
                <span style="color:#f97316;">${bestWave}</span>
            </p>
            <p style="margin-top:8px;">
                Los datos se guardan localmente en tu navegador mediante <strong>localStorage</strong>.
                Si borras los datos del navegador, se perderán los registros.
            </p>
        `;
    }

    // =========================
    // ENTIDADES
    // =========================

    function createPlayer() {
        const width = 40;
        const height = 24;
        return {
            x: GAME_WIDTH / 2 - width / 2,
            y: GAME_HEIGHT - 80,
            width,
            height,
            speed: 280,
            lives: currentDifficulty.playerLives,
            shootCooldown: 0,
            shootDelay: 250, // ms
            doubleShotTimer: 0,
            shieldTimer: 0
        };
    }

    function createEnemiesForWave(waveNumber) {
        enemies = [];
        enemyBullets = [];
        powerUps = [];
        explosions = [];

        const rowsBase = currentDifficulty.enemyRows;
        const colsBase = currentDifficulty.enemyCols;
        const rows = clamp(rowsBase + Math.floor((waveNumber - 1) / 3), rowsBase, rowsBase + 3);
        const cols = colsBase;

        const paddingX = 40;
        const paddingY = 50;
        const gapX = 50;
        const gapY = 40;
        const startX = (GAME_WIDTH - (cols - 1) * gapX) / 2 - 20;
        const startY = 50;

        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                const type = row >= rows - 2 ? 'tough' : 'normal'; // filas inferiores más resistentes
                const hp = type === 'tough' ? 2 : 1;
                enemies.push({
                    x: startX + col * gapX,
                    y: startY + row * gapY,
                    width: 32,
                    height: 24,
                    hp,
                    type,
                    value: type === 'tough' ? 200 : 100
                });
            }
        }

        // ocasional jefe en ciertas oleadas
        if (waveNumber % 5 === 0) {
            enemies.push({
                x: GAME_WIDTH / 2 - 40,
                y: 30,
                width: 80,
                height: 30,
                hp: 6,
                type: 'boss',
                value: 500
            });
        }

        enemyDirection = 1;
        baseEnemySpeed = currentDifficulty.enemySpeed + (waveNumber - 1) * 8;
    }

    function createStars() {
        stars = [];
        const starCount = 90;
        for (let i = 0; i < starCount; i++) {
            stars.push({
                x: Math.random() * GAME_WIDTH,
                y: Math.random() * GAME_HEIGHT,
                radius: Math.random() * 1.4 + 0.4,
                baseAlpha: Math.random() * 0.6 + 0.2,
                twinkleSpeed: (Math.random() * 0.5 + 0.5) * 0.003,
                twinkleOffset: Math.random() * Math.PI * 2
            });
        }
    }

    // =========================
    // MENÚS / ESTADO
    // =========================

    function showOverlay(element) {
        mainMenu.classList.add('hidden');
        difficultyMenu.classList.add('hidden');
        instructionsScreen.classList.add('hidden');
        highScoresScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        if (element) {
            element.classList.remove('hidden');
        }
    }

    function goToMainMenu() {
        gameState = 'menu';
        showOverlay(mainMenu);
    }

    function startNewGame() {
        score = 0;
        wave = 1;
        player = createPlayer();
        createEnemiesForWave(wave);
        createStars();
        slowEnemiesTimer = 0;
        gameState = 'playing';
        showOverlay(null);
        refreshHud();
    }

    function goToNextWave() {
        wave++;
        createEnemiesForWave(wave);
        slowEnemiesTimer = 0;
    }

    function endGame(victory) {
        gameState = 'gameover';
        saveHighScores();
        refreshHud();

        finalScoreEl.textContent = score;
        finalWaveEl.textContent = wave;
        bestScoreGlobalEl.textContent = highScore;
        tagDifficulty.textContent = 'Dificultad: ' + currentDifficulty.label;

        if (victory) {
            gameOverTitle.textContent = '¡Victoria!';
            gameOverNote.textContent = 'Has repelido la invasión Andro. Tu leyenda quedará en las estrellas.';
        } else {
            gameOverTitle.textContent = 'Game Over';
            gameOverNote.textContent = 'Los invasores alcanzaron la órbita. Vuelve a intentarlo y mejora tu estrategia.';
        }

        showOverlay(gameOverScreen);
    }

    // =========================
    // ENTRADA (TECLADO / MÓVIL)
    // =========================

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            e.preventDefault();
        }
        keys[e.code] = true;
    });

    window.addEventListener('keyup', (e) => {
        keys[e.code] = false;
    });

    function attachMobileButton(button, onDown, onUp) {
        button.addEventListener('mousedown', (e) => {
            e.preventDefault();
            onDown();
        });
        button.addEventListener('mouseup', (e) => {
            e.preventDefault();
            onUp();
        });
        button.addEventListener('mouseleave', (e) => {
            onUp();
        });
        button.addEventListener('touchstart', (e) => {
            e.preventDefault();
            onDown();
        }, { passive: false });
        button.addEventListener('touchend', (e) => {
            e.preventDefault();
            onUp();
        });
        button.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            onUp();
        });
    }

    attachMobileButton(btnLeft,
        () => { mobileMoveLeft = true; },
        () => { mobileMoveLeft = false; }
    );

    attachMobileButton(btnRight,
        () => { mobileMoveRight = true; },
        () => { mobileMoveRight = false; }
    );

    attachMobileButton(btnFire,
        () => { mobileFiring = true; },
        () => { mobileFiring = false; }
    );

    // =========================
    // LÓGICA DE DISPARO
    // =========================

    function playerShoot() {
        if (!player) return;
        const now = performance.now();
        if (player.shootCooldown > 0) return;

        const bulletSpeed = 380;
        const baseBullet = {
            x: player.x + player.width / 2 - 3,
            y: player.y - 6,
            width: 6,
            height: 12,
            speed: bulletSpeed
        };

        const bulletsToAdd = [];

        if (player.doubleShotTimer > 0) {
            // doble disparo
            bulletsToAdd.push({
                ...baseBullet,
                x: player.x + player.width * 0.3 - 3
            });
            bulletsToAdd.push({
                ...baseBullet,
                x: player.x + player.width * 0.7 - 3
            });
        } else {
            bulletsToAdd.push(baseBullet);
        }

        playerBullets.push(...bulletsToAdd);
        player.shootCooldown = player.shootDelay;
    }

    function enemyShoot(enemy) {
        const bullet = {
            x: enemy.x + enemy.width / 2 - 3,
            y: enemy.y + enemy.height,
            width: 6,
            height: 12,
            speed: currentDifficulty.enemyBulletSpeed
        };
        enemyBullets.push(bullet);
    }

    // =========================
    // POWER-UPS
    // =========================

    function spawnPowerUp(enemy) {
        const chance = currentDifficulty.powerUpChance;
        if (Math.random() > chance) return;

        const types = ['double', 'shield', 'slow'];
        const type = getRandomItem(types);
        powerUps.push({
            x: enemy.x + enemy.width / 2 - 10,
            y: enemy.y + enemy.height / 2,
            width: 20,
            height: 20,
            speed: 80,
            type
        });
    }

    function applyPowerUp(type) {
        const now = performance.now();
        if (type === 'double') {
            player.doubleShotTimer = 8000; // ms
        } else if (type === 'shield') {
            player.shieldTimer = 8000;
        } else if (type === 'slow') {
            slowEnemiesTimer = 7000;
        }
    }

    // =========================
    // EXPLOSIONES
    // =========================

    function spawnExplosion(x, y, color) {
        explosions.push({
            x,
            y,
            radius: 6,
            maxRadius: 20,
            life: 300, // ms
            color
        });
    }

    // =========================
    // ACTUALIZACIÓN DEL JUEGO
    // =========================

    function update(delta) {
        if (gameState !== 'playing') return;

        const dt = delta; // ms
        const dtSec = dt / 1000;

        if (!player) return;

        // Actualizar temporizadores de power-ups
        if (player.shootCooldown > 0) {
            player.shootCooldown -= dt;
            if (player.shootCooldown < 0) player.shootCooldown = 0;
        }
        if (player.doubleShotTimer > 0) {
            player.doubleShotTimer -= dt;
            if (player.doubleShotTimer < 0) player.doubleShotTimer = 0;
        }
        if (player.shieldTimer > 0) {
            player.shieldTimer -= dt;
            if (player.shieldTimer < 0) player.shieldTimer = 0;
        }
        if (slowEnemiesTimer > 0) {
            slowEnemiesTimer -= dt;
            if (slowEnemiesTimer < 0) slowEnemiesTimer = 0;
        }

        // Movimiento del jugador
        let moveDir = 0;
        if (keys['ArrowLeft'] || keys['KeyA'] || mobileMoveLeft) moveDir -= 1;
        if (keys['ArrowRight'] || keys['KeyD'] || mobileMoveRight) moveDir += 1;

        player.x += moveDir * player.speed * dtSec;
        player.x = clamp(player.x, 20, GAME_WIDTH - player.width - 20);

        // Disparo jugador (teclado / móvil)
        if (keys['Space'] || mobileFiring) {
            playerShoot();
        }

        // Movimiento de balas del jugador
        for (let i = playerBullets.length - 1; i >= 0; i--) {
            const b = playerBullets[i];
            b.y -= b.speed * dtSec;
            if (b.y + b.height < 0) {
                playerBullets.splice(i, 1);
            }
        }

        // Movimiento de enemigos (estilo Space Invaders)
        if (enemies.length > 0) {
            let leftMost = GAME_WIDTH;
            let rightMost = 0;
            for (const e of enemies) {
                if (e.x < leftMost) leftMost = e.x;
                if (e.x + e.width > rightMost) rightMost = e.x + e.width;
            }

            const slowFactor = slowEnemiesTimer > 0 ? SLOW_FACTOR : 1;
            const enemySpeed = baseEnemySpeed * slowFactor;

            const dx = enemySpeed * dtSec * enemyDirection;
            let hitEdge = false;

            for (const e of enemies) {
                e.x += dx;
            }

            if (leftMost + dx < 20 || rightMost + dx > GAME_WIDTH - 20) {
                hitEdge = true;
            }

            if (hitEdge) {
                enemyDirection *= -1;
                for (const e of enemies) {
                    e.y += currentDifficulty.enemyDrop;
                }
                baseEnemySpeed *= 1.02;
            }
        }

        // Enemigos disparan aleatoriamente
        for (const e of enemies) {
            if (Math.random() < currentDifficulty.enemyShootChance) {
                enemyShoot(e);
            }
        }

        // Movimiento de balas enemigas
        for (let i = enemyBullets.length - 1; i >= 0; i--) {
            const b = enemyBullets[i];
            b.y += b.speed * dtSec;
            if (b.y > GAME_HEIGHT + 40) {
                enemyBullets.splice(i, 1);
            }
        }

        // Movimiento de power-ups
        for (let i = powerUps.length - 1; i >= 0; i--) {
            const p = powerUps[i];
            p.y += p.speed * dtSec;
            if (p.y > GAME_HEIGHT + 40) {
                powerUps.splice(i, 1);
            }
        }

        // Actualizar explosiones
        for (let i = explosions.length - 1; i >= 0; i--) {
            const ex = explosions[i];
            ex.life -= dt;
            ex.radius = ex.maxRadius * (1 - ex.life / 300);
            if (ex.life <= 0) {
                explosions.splice(i, 1);
            }
        }

        // Colisiones: balas del jugador con enemigos
        for (let i = playerBullets.length - 1; i >= 0; i--) {
            const b = playerBullets[i];
            let hit = false;
            for (let j = enemies.length - 1; j >= 0; j--) {
                const e = enemies[j];
                if (rectsCollide(b, e)) {
                    hit = true;
                    e.hp -= 1;

                    if (e.hp <= 0) {
                        score += e.value;
                        spawnExplosion(e.x + e.width / 2, e.y + e.height / 2,
                            e.type === 'boss' ? '#f97316' : '#facc15');
                        spawnPowerUp(e);
                        enemies.splice(j, 1);
                    } else {
                        spawnExplosion(e.x + e.width / 2, e.y + e.height / 2, '#f97316');
                    }
                    break;
                }
            }
            if (hit) {
                playerBullets.splice(i, 1);
            }
        }

        // Colisiones: balas enemigas con jugador
        for (let i = enemyBullets.length - 1; i >= 0; i--) {
            const b = enemyBullets[i];
            if (rectsCollide(b, player)) {
                enemyBullets.splice(i, 1);
                if (player.shieldTimer > 0) {
                    spawnExplosion(player.x + player.width / 2, player.y, '#22c55e');
                    player.shieldTimer = 0;
                } else {
                    player.lives -= 1;
                    spawnExplosion(player.x + player.width / 2, player.y, '#f87171');
                    if (player.lives <= 0) {
                        endGame(false);
                        return;
                    }
                }
            }
        }

        // Colisiones: power-ups con jugador
        for (let i = powerUps.length - 1; i >= 0; i--) {
            const p = powerUps[i];
            if (rectsCollide(p, player)) {
                applyPowerUp(p.type);
                spawnExplosion(p.x + p.width / 2, p.y + p.height / 2, '#a855f7');
                powerUps.splice(i, 1);
            }
        }

        // Si enemigos llegan al fondo: Game Over
        for (const e of enemies) {
            if (e.y + e.height >= player.y + player.height / 2) {
                endGame(false);
                return;
            }
        }

        // Si no quedan enemigos -> pasa a siguiente oleada / victoria
        if (enemies.length === 0) {
            if (wave >= VICTORY_WAVE) {
                endGame(true);
                return;
            } else {
                goToNextWave();
            }
        }

        // Actualizar estrellas (parpadeo)
        const t = performance.now();
        for (const s of stars) {
            const tw = Math.sin(s.twinkleOffset + t * s.twinkleSpeed);
            s.alpha = clamp(s.baseAlpha + tw * 0.2, 0.1, 1);
        }

        // Refrescar HUD
        refreshHud();
    }

    // =========================
    // RENDERIZADO
    // =========================

    function render() {
        // Fondo espacial
        const gradient = ctx.createRadialGradient(
            GAME_WIDTH / 2, 0, 80,
            GAME_WIDTH / 2, GAME_HEIGHT / 2, GAME_HEIGHT
        );
        gradient.addColorStop(0, '#111827');
        gradient.addColorStop(0.4, '#020617');
        gradient.addColorStop(1, '#000000');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

        // Estrellas
        for (const s of stars) {
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(248, 250, 252, ${s.alpha || s.baseAlpha})`;
            ctx.fill();
        }

        if (gameState !== 'playing') {
            // igual dibujamos naves, etc. si queremos, pero basta con mostrar fondo
        }

        if (player) {
            // Nave del jugador (triángulo / nave futurista)
            ctx.save();
            ctx.translate(player.x + player.width / 2, player.y + player.height / 2);

            ctx.shadowColor = '#60a5fa';
            ctx.shadowBlur = 20;

            ctx.beginPath();
            ctx.moveTo(0, -player.height / 2); // punta
            ctx.lineTo(-player.width / 2, player.height / 2);
            ctx.lineTo(player.width / 2, player.height / 2);
            ctx.closePath();
            ctx.fillStyle = '#38bdf8';
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(0, -player.height / 2 + 4);
            ctx.lineTo(-player.width / 4, player.height / 2 - 2);
            ctx.lineTo(player.width / 4, player.height / 2 - 2);
            ctx.closePath();
            ctx.fillStyle = '#1d4ed8';
            ctx.fill();

            // Escudo
            if (player.shieldTimer > 0) {
                const alpha = 0.4 + 0.2 * Math.sin(performance.now() * 0.01);
                ctx.beginPath();
                ctx.arc(0, 0, player.width * 0.9, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(56, 189, 248, ${alpha})`;
                ctx.lineWidth = 3;
                ctx.stroke();
            }

            ctx.restore();
        }

        // Balas del jugador
        for (const b of playerBullets) {
            ctx.save();
            ctx.shadowColor = '#22c55e';
            ctx.shadowBlur = 10;
            ctx.fillStyle = '#bbf7d0';
            ctx.fillRect(b.x, b.y, b.width, b.height);
            ctx.restore();
        }

        // Enemigos
        for (const e of enemies) {
            ctx.save();
            let colorBody = '#f97316';
            let colorGlow = '#fb923c';
            if (e.type === 'tough') {
                colorBody = '#e11d48';
                colorGlow = '#fb7185';
            } else if (e.type === 'boss') {
                colorBody = '#a855f7';
                colorGlow = '#c4b5fd';
            }

            ctx.shadowColor = colorGlow;
            ctx.shadowBlur = 18;

            // cuerpo
            ctx.fillStyle = colorBody;
            ctx.fillRect(e.x, e.y, e.width, e.height);

            // detalles
            ctx.fillStyle = '#020617';
            ctx.fillRect(e.x + 4, e.y + 4, e.width - 8, e.height / 2);

            ctx.restore();
        }

        // Balas enemigas
        for (const b of enemyBullets) {
            ctx.save();
            ctx.shadowColor = '#f97316';
            ctx.shadowBlur = 8;
            ctx.fillStyle = '#fed7aa';
            ctx.fillRect(b.x, b.y, b.width, b.height);
            ctx.restore();
        }

        // Power-ups
        for (const p of powerUps) {
            ctx.save();
            ctx.shadowBlur = 12;
            let colorFill = '#a855f7';
            if (p.type === 'double') {
                colorFill = '#22c55e';
                ctx.shadowColor = '#4ade80';
            } else if (p.type === 'shield') {
                colorFill = '#38bdf8';
                ctx.shadowColor = '#7dd3fc';
            } else if (p.type === 'slow') {
                colorFill = '#eab308';
                ctx.shadowColor = '#facc15';
            }

            ctx.beginPath();
            ctx.arc(p.x + p.width / 2, p.y + p.height / 2, p.width / 2, 0, Math.PI * 2);
            ctx.fillStyle = colorFill;
            ctx.fill();

            ctx.fillStyle = '#0f172a';
            ctx.font = '10px system-ui';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            if (p.type === 'double') ctx.fillText('2x', p.x + p.width / 2, p.y + p.height / 2);
            if (p.type === 'shield') ctx.fillText('S', p.x + p.width / 2, p.y + p.height / 2 + 1);
            if (p.type === 'slow') ctx.fillText('↓', p.x + p.width / 2, p.y + p.height / 2 + 1);

            ctx.restore();
        }

        // Explosiones
        for (const ex of explosions) {
            ctx.save();
            const alpha = ex.life / 300;
            ctx.beginPath();
            ctx.arc(ex.x, ex.y, ex.radius, 0, Math.PI * 2);
            ctx.fillStyle = ex.color.replace(')', `, ${alpha})`).replace('rgb', 'rgba');
            // si el color no es rgba original, usar esta aproximación:
            ctx.fillStyle = ex.color;
            ctx.globalAlpha = alpha;
            ctx.shadowColor = ex.color;
            ctx.shadowBlur = 18;
            ctx.fill();
            ctx.restore();
        }
    }

    // =========================
    // BUCLE PRINCIPAL
    // =========================

    function gameLoop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        const delta = timestamp - lastTime;
        lastTime = timestamp;

        update(delta);
        render();

        gameLoopId = requestAnimationFrame(gameLoop);
    }

    // =========================
    // MANEJO DE MENÚS / BOTONES
    // =========================

    // Menú principal
    btnPlayMain.addEventListener('click', () => {
        startNewGame();
    });

    btnDifficultyMenu.addEventListener('click', () => {
        showOverlay(difficultyMenu);
    });

    btnInstructionsMenu.addEventListener('click', () => {
        showOverlay(instructionsScreen);
    });

    btnHighScoresMenu.addEventListener('click', () => {
        fillHighScoresScreen();
        showOverlay(highScoresScreen);
    });

    // Menú de dificultad
    document.querySelectorAll('.difficulty-option').forEach(el => {
        el.addEventListener('click', () => {
            document.querySelectorAll('.difficulty-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            const diffKey = el.getAttribute('data-difficulty');
            currentDifficultyKey = diffKey;
            currentDifficulty = DIFFICULTIES[diffKey];
            HUD_DIFF.textContent = currentDifficulty.label;
        });
    });

    btnDiffAccept.addEventListener('click', () => {
        showOverlay(mainMenu);
    });

    btnDiffBack.addEventListener('click', () => {
        showOverlay(mainMenu);
    });

    // Instrucciones
    btnInstructionsBack.addEventListener('click', () => {
        showOverlay(mainMenu);
    });

    // High Scores
    btnHighScoresBack.addEventListener('click', () => {
        showOverlay(mainMenu);
    });

    // Game over
    btnPlayAgain.addEventListener('click', () => {
        startNewGame();
    });

    btnBackToMenu.addEventListener('click', () => {
        goToMainMenu();
    });

    // =========================
    // INICIALIZACIÓN
    // =========================

    function init() {
        loadHighScores();
        createStars();
        refreshHud();
        showOverlay(mainMenu);
        lastTime = performance.now();
        gameLoopId = requestAnimationFrame(gameLoop);
    }

    init();
</script>
</body>
</html>
